<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>X Veritas Collegiate - Student Portal</title>
  <style>
    :root {
      --navy: #0a1526;
      --oxblood: #8b1c1c;
      --parchment: #f4ecdd;
      --charcoal: #1a1a1a;
      --gold: #c5a76e;
      --dark-gray: #555;
      --font-display: 'Georgia', serif;
      --font-body: 'Arial', sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--font-body);
      background-color: var(--parchment);
      color: var(--charcoal);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    nav {
      background-color: var(--navy);
      display: flex;
      justify-content: space-around;
      padding: 1rem 0;
    }

    nav button {
      background: none;
      border: none;
      color: var(--parchment);
      font-weight: 700;
      font-family: var(--font-display);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    nav button:hover, nav button.active {
      background-color: var(--oxblood);
      color: var(--gold);
    }
    nav button.logout {
      margin-left: auto;
      background-color: var(--oxblood);
      color: var(--gold);
    }

    main {
      flex: 1;
      padding: 1rem 2rem;
      max-width: 960px;
      margin: 0 auto;
    }

    section.portal-section {
      display: none;
      outline: none;
    }

    section.portal-section.active {
      display: block;
    }

    h2 {
      font-family: var(--font-display);
      color: var(--oxblood);
      margin-bottom: 1rem;
    }

    /* Home slideshow */
    #home .slideshow {
      position: relative;
      height: 220px;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #home .slideshow img {
      position: absolute;
      width: 100%;
      height: 220px;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      border-radius: 12px;
    }
    #home .slideshow img.active {
      opacity: 1;
      position: relative;
    }

    /* Quote box */
    #quoteBox {
      font-style: italic;
      margin-bottom: 2rem;
      font-size: 1.2rem;
      color: var(--dark-gray);
      border-left: 4px solid var(--oxblood);
      padding-left: 1rem;
      font-family: Georgia, serif;
    }

    /* Assignments */
    form label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    form input[type="text"],
    form select,
    form input[type="file"],
    form textarea,
    form input[type="email"],
    form input[type="tel"],
    form input[type="password"] {
      width: 100%;
      padding: 0.4rem 0.6rem;
      margin-top: 0.2rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      font-family: var(--font-body);
      box-sizing: border-box;
    }
    form textarea {
      resize: vertical;
    }
    form button {
      margin-top: 1rem;
      background-color: var(--oxblood);
      color: var(--gold);
      font-weight: bold;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      font-family: var(--font-display);
      transition: background-color 0.3s ease;
    }
    form button:hover {
      background-color: #a71515;
    }

    /* Submitted assignments list */
    #submittedAssignments ul {
      list-style-type: disc;
      margin-left: 1.5rem;
    }

    /* Exams Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    table thead tr {
      background-color: var(--oxblood);
      color: var(--gold);
    }
    table th, table td {
      padding: 0.6rem 0.8rem;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: middle;
    }
    table tbody tr:nth-child(even) {
      background-color: #fafafa;
    }
    table button {
      background-color: var(--oxblood);
      color: var(--gold);
      border: none;
      padding: 0.3rem 0.8rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    table button:hover {
      background-color: #a71515;
    }

    /* Chat and Inbox */
    #chatSidebar {
      width: 220px;
      background-color: #f2f2f2;
      border-right: 2px solid var(--oxblood);
      height: 320px;
      overflow-y: auto;
      float: left;
      margin-right: 1rem;
      border-radius: 10px;
    }
    #chatSidebar h2 {
      padding: 0.6rem 1rem;
      margin: 0;
      background-color: var(--oxblood);
      color: var(--gold);
      font-size: 1.2rem;
      border-radius: 10px 10px 0 0;
    }
    #chatList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #chatList li {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }
    #chatList li.active,
    #chatList li:hover {
      background-color: var(--oxblood);
      color: var(--gold);
      font-weight: 700;
      outline: none;
    }

    #chatWindow {
      overflow-y: auto;
      height: 320px;
      border: 2px solid var(--oxblood);
      border-radius: 10px;
      padding: 1rem;
      box-sizing: border-box;
      margin-left: 240px;
      background-color: #fff;
      display: flex;
      flex-direction: column;
    }
    #chatHeader {
      font-weight: 700;
      font-family: var(--font-display);
      margin-bottom: 0.6rem;
      font-size: 1.3rem;
      border-bottom: 1px solid var(--oxblood);
      padding-bottom: 0.4rem;
    }
    #messageThread {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 0.5rem;
      margin-bottom: 0.8rem;
      background: #fafafa;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    #messageForm select,
    #messageForm input[type="text"],
    #messageForm textarea {
      margin-bottom: 0.5rem;
    }
    #messageForm textarea {
      height: 60px;
    }

    .message {
      margin-bottom: 0.5rem;
      padding: 0.3rem 0.5rem;
      border-radius: 8px;
      max-width: 80%;
      white-space: pre-wrap;
    }
    .message.sent {
      background-color: var(--gold);
      align-self: flex-end;
      color: var(--oxblood);
    }
    .message.received {
      background-color: var(--oxblood);
      color: var(--gold);
      align-self: flex-start;
    }

    /* Calendar */
    #calendarHeader {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }
    #calendarHeader button {
      background-color: var(--oxblood);
      border: none;
      color: var(--gold);
      font-weight: 700;
      font-size: 1.3rem;
      cursor: pointer;
      border-radius: 8px;
      width: 35px;
      height: 35px;
    }
    #monthYearLabel {
      min-width: 200px;
      text-align: center;
    }
    #calendarTable {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    #calendarTable th, #calendarTable td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px 4px;
      vertical-align: top;
      height: 90px;
      position: relative;
      cursor: pointer;
    }
    #calendarTable td span.event {
      display: block;
      background-color: var(--oxblood);
      color: var(--gold);
      font-size: 0.7rem;
      border-radius: 5px;
      margin-top: 4px;
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #addEventBtn {
      background-color: var(--oxblood);
      color: var(--gold);
      border: none;
      font-weight: 700;
      padding: 0.6rem 1.2rem;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 1rem;
    }
    #addEventBtn:hover {
      background-color: #a71515;
    }

    /* Modal for adding events */
    #eventModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    #eventModal.active {
      display: flex;
    }
    #eventModalContent {
      background: var(--parchment);
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    /* Settings */
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* Library section */
    #library {
      max-width: 700px;
      margin: 0 auto;
    }
    #genreSelect {
      margin-bottom: 1rem;
      width: 100%;
      padding: 0.5rem 0.7rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #bookList {
      list-style: none;
      padding-left: 1rem;
    }
    #bookList li {
      margin-bottom: 0.8rem;
    }
    #bookList li a {
      color: var(--oxblood);
      text-decoration: none;
      font-weight: 600;
    }
    #bookList li a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 800px) {
      #chatSidebar {
        float: none;
        width: 100%;
        height: auto;
        border-right: none;
        margin-bottom: 1rem;
      }
      #chatWindow {
        margin-left: 0;
        height: auto;
      }
    }
  </style>
</head>
<body>

<nav role="navigation" aria-label="Primary navigation">
  <button aria-controls="home" class="active" aria-selected="true">Home</button>
  <button aria-controls="assignments" aria-selected="false">Assignments</button>
  <button aria-controls="exams" aria-selected="false">Exams</button>
  <button aria-controls="inbox" aria-selected="false">Inbox</button>
  <button aria-controls="library" aria-selected="false">Library</button>
  <button aria-controls="calendar" aria-selected="false">Calendar</button>
  <button aria-controls="settings" aria-selected="false">Settings</button>
  <button id="logoutBtn" class="logout">Logout</button>
</nav>

<main>
  <!-- HOME -->
  <section id="home" class="portal-section active" tabindex="0" aria-live="polite">
    <h2>Welcome to X Veritas Collegiate</h2>
    <div class="slideshow" aria-label="Motivational slideshow">
      <img src="https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&w=960&q=80" alt="Sunrise over mountains" class="active" />
      <img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?auto=format&fit=crop&w=960&q=80" alt="Students studying" />
      <img src="https://images.unsplash.com/photo-1517520287167-4bbf64a00d66?auto=format&fit=crop&w=960&q=80" alt="Library books" />
      <img src="https://images.unsplash.com/photo-1476958526483-36efcaa80b5d?auto=format&fit=crop&w=960&q=80" alt="Campus building" />
      <img src="https://images.unsplash.com/photo-1531219432768-170320b5b8a7?auto=format&fit=crop&w=960&q=80" alt="Young people collaborating" />
    </div>
    <div id="quoteBox" aria-live="polite" aria-atomic="true"></div>

    <div id="homeMessages" style="margin-top:2rem;">
      <h3>Recent Incoming Messages</h3>
      <div id="incomingMessages" style="border: 1px solid var(--oxblood); background: #fff9e5; padding: 1rem; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;"></div>
    </div>
  </section>

  <!-- ASSIGNMENTS -->
  <section id="assignments" class="portal-section" tabindex="0" aria-live="polite">
    <h2>Submit Assignments</h2>
    <form id="assignmentForm" aria-label="Submit assignment form" enctype="multipart/form-data">
      <label for="assignmentSubject">Subject:</label>
      <select id="assignmentSubject" name="assignmentSubject" required>
        <option value="">Select Subject</option>
        <option>Logic</option>
        <option>Rhetoric</option>
        <option>Systems Analysis</option>
        <option>Tactical Mathematics</option>
        <option>Critical Ethics</option>
        <option>Complex Simulations</option>
        <option>Interdisciplinary Strategy</option>
        <option>Code & Cipher</option>
        <option>Advanced Decision Sciences</option>
        <option>Strategic Intelligence & Analysis</option>
        <option>Advanced Engineering & Technology</option>
        <option>Leadership Studies & Ethics</option>
        <option>Cyber Operations & Defense</option>
        <option>Communications & Media Strategy</option>
        <option>Thesis Initiative</option>
        <option>Lab Deployments</option>
        <option>Public Defense Panels</option>
        <option>Orientation Materials</option>
      </select>

      <label for="assignmentFile">Upload File:</label>
      <input type="file" id="assignmentFile" name="assignmentFile" accept=".pdf,.doc,.docx,.txt" required />

      <button type="submit">Submit</button>
    </form>

    <div id="submittedAssignments" aria-live="polite" aria-atomic="true" style="margin-top:1rem;">
      <h3>Your Submitted Assignments:</h3>
      <ul id="assignmentsList" aria-label="List of submitted assignments"></ul>
    </div>
  </section>

  <!-- EXAMS -->
  <section id="exams" class="portal-section" tabindex="0" aria-live="polite">
    <h2>Exams</h2>

    <label for="examSubject">Select Subject to View or Take Exams:</label>
    <select id="examSubject" aria-describedby="examHelp">
      <option value="">-- Choose Subject --</option>
      <option>Logic</option>
      <option>Rhetoric</option>
      <option>Systems Analysis</option>
      <option>Tactical Mathematics</option>
      <option>Critical Ethics</option>
      <option>Complex Simulations</option>
      <option>Interdisciplinary Strategy</option>
      <option>Code & Cipher</option>
      <option>Advanced Decision Sciences</option>
      <option>Strategic Intelligence & Analysis</option>
      <option>Advanced Engineering & Technology</option>
      <option>Leadership Studies & Ethics</option>
      <option>Cyber Operations & Defense</option>
      <option>Communications & Media Strategy</option>
      <option>Thesis Initiative</option>
      <option>Lab Deployments</option>
      <option>Public Defense Panels</option>
      <option>Orientation Materials</option>
    </select>

    <button id="loadExamsBtn">Load Exams</button>
    <div id="examsContainer" style="margin-top:1rem;"></div>

  </section>

  <!-- INBOX -->
  <section id="inbox" class="portal-section" tabindex="0" aria-live="polite" style="position: relative;">

    <h2>Inbox</h2>
    <div id="chatSidebar" role="list" aria-label="Departments and contacts">
      <h2>Departments</h2>
      <ul id="chatList" tabindex="0">
        <li tabindex="0" class="active" role="listitem">IT Department</li>
        <li tabindex="0" role="listitem">President</li>
        <li tabindex="0" role="listitem">Dean of Admissions</li>
        <li tabindex="0" role="listitem">Professor B</li>
        <li tabindex="0" role="listitem">MothersMilk</li>
      </ul>
    </div>

    <div id="chatWindow" role="region" aria-live="polite" aria-atomic="true" aria-label="Message thread">
      <div id="chatHeader">IT Department</div>
      <div id="messageThread" tabindex="0" aria-live="polite" aria-atomic="true"></div>
      <form id="messageForm" aria-label="Send message form">
        <label for="recipientSelect">Send To:</label>
        <select id="recipientSelect" multiple size="5" aria-describedby="recipientHelp">
          <option>IT Department</option>
          <option>President</option>
          <option>Dean of Admissions</option>
          <option>Professor B</option>
          <option>MothersMilk</option>
        </select>
        <small id="recipientHelp">Hold Ctrl (Cmd on Mac) to select multiple recipients.</small>
        <label for="messageInput">Message:</label>
        <textarea id="messageInput" rows="3" required></textarea>
        <button type="submit">Send</button>
      </form>
    </div>

  </section>

  <!-- LIBRARY -->
  <section id="library" class="portal-section" tabindex="0" aria-live="polite">
    <h2>Library</h2>
    <label for="genreSelect">Select Genre:</label>
    <select id="genreSelect">
      <option value="">-- Select Genre --</option>
      <option value="fiction">Fiction</option>
      <option value="nonfiction">Non-Fiction</option>
      <option value="science">Science & Technology</option>
      <option value="history">History</option>
      <option value="philosophy">Philosophy & Ethics</option>
      <option value="religion">Religion & Spirituality</option>
      <option value="classic">Classics</option>
    </select>
    <ul id="bookList" aria-live="polite" aria-atomic="true"></ul>
  </section>

  <!-- CALENDAR -->
  <section id="calendar" class="portal-section" tabindex="0" aria-live="polite">
    <h2>Calendar</h2>
    <div id="calendarHeader">
      <button id="prevMonthBtn" aria-label="Previous Month">&lt;</button>
      <div id="monthYearLabel" aria-live="polite" aria-atomic="true"></div>
      <button id="nextMonthBtn" aria-label="Next Month">&gt;</button>
    </div>
    <table id="calendarTable" aria-label="Calendar">
      <thead>
        <tr>
          <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="addEventBtn">Add Event</button>

    <div id="eventModal" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
      <div id="eventModalContent">
        <h3 id="eventModalTitle">Add Calendar Event</h3>
        <form id="eventForm">
          <label for="eventDate">Date:</label>
          <input type="date" id="eventDate" required />
          <label for="eventDesc">Description:</label>
          <input type="text" id="eventDesc" maxlength="50" required />
          <div style="margin-top: 1rem;">
            <button type="submit">Add</button>
            <button type="button" id="cancelEventBtn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="portal-section" tabindex="0" aria-live="polite">
    <h2>Settings</h2>
    <div class="card">
      <form id="settingsForm" aria-label="User settings form">
        <label for="profilePic">Upload Profile Picture:</label>
        <input type="file" id="profilePic" accept="image/*" />
        <label for="recoveryEmail">Recovery Email:</label>
        <input type="email" id="recoveryEmail" placeholder="you@example.com" />
        <label for="recoveryPhone">Recovery Phone:</label>
        <input type="tel" id="recoveryPhone" placeholder="+1 555 123 4567" />
        <label for="securityQuestion">Security Question:</label>
        <input type="text" id="securityQuestion" placeholder="Your favorite teacher?" />
        <label for="resetPassword">Reset Password:</label>
        <input type="password" id="resetPassword" placeholder="New password" />
        <button type="submit">Save Settings</button>
      </form>
    </div>
  </section>
</main>

<script>
 (() => {
  // ======= NAVIGATION TAB SWITCHING =======
  const navButtons = document.querySelectorAll('nav button:not(.logout)');
  const sections = document.querySelectorAll('section.portal-section');

  function setActiveTab(targetId) {
    sections.forEach(sec => {
      sec.classList.toggle('active', sec.id === targetId);
    });
    navButtons.forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('aria-controls') === targetId);
      btn.setAttribute('aria-selected', btn.getAttribute('aria-controls') === targetId);
    });
    const activeSection = document.getElementById(targetId);
    if (activeSection) activeSection.focus();
  }

  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      setActiveTab(btn.getAttribute('aria-controls'));
    });
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    alert('Logging out...');
    window.location.href = 'login.html';
  });


  // ======= HOME SLIDESHOW & QUOTES =======
  const slideshowImages = document.querySelectorAll('#home .slideshow img');
  const quoteBox = document.getElementById('quoteBox');
  const incomingMessagesDiv = document.getElementById('incomingMessages');
  const upcomingDatesList = document.getElementById('upcomingDates');
  const newsSection = document.getElementById('newsSection');

  const quotes = [
    "“And if men come unto me I will show unto them their weakness.” — Ether 12:27",
    "“Wherefore, ye may also have hope.” — Ether 12:4",
    "“Pray always, that you may come off conqueror.” — Alma 37:6",
    "“When you are in the service of your fellow beings ye are only in the service of your God.” — Mosiah 2:17",
    "“Faith is things which are hoped for and not seen.” — Hebrews 11:1",
    "“For the natural man is an enemy to God.” — Mosiah 3:19",
    "“By small and simple things are great things brought to pass.” — Alma 37:6",
    "“Trust in the Lord with all thine heart.” — Proverbs 3:5",
    "“Wherefore, be not weary in well-doing.” — 2 Nephi 31:20"
  ];

  let currentSlide = 0;
  let currentQuote = 0;

  function cycleSlideshow() {
    slideshowImages.forEach((img, i) => {
      img.classList.toggle('active', i === currentSlide);
    });
    currentSlide = (currentSlide + 1) % slideshowImages.length;
  }

  function cycleQuote() {
    quoteBox.textContent = quotes[currentQuote];
    currentQuote = (currentQuote + 1) % quotes.length;
  }

  setInterval(cycleSlideshow, 7000);
  setInterval(cycleQuote, 9000);

  cycleSlideshow();
  cycleQuote();


  // ======= ASSIGNMENTS SUBMISSION =======
  const assignmentForm = document.getElementById('assignmentForm');
  const assignmentsList = document.getElementById('assignmentsList');

  let submittedAssignments = JSON.parse(localStorage.getItem('submittedAssignments') || '[]');

  function renderAssignments() {
    assignmentsList.innerHTML = '';
    if (submittedAssignments.length === 0) {
      assignmentsList.innerHTML = '<li>No submitted assignments yet.</li>';
      return;
    }
    submittedAssignments.forEach(a => {
      const li = document.createElement('li');
      li.textContent = `${a.subject} - ${a.fileName} (${a.date})`;
      assignmentsList.appendChild(li);
    });
  }
  renderAssignments();

  assignmentForm.addEventListener('submit', e => {
    e.preventDefault();
    const subject = assignmentForm.assignmentSubject.value;
    const fileInput = assignmentForm.assignmentFile;
    if (!subject) {
      alert('Please select a subject.');
      return;
    }
    if (fileInput.files.length === 0) {
      alert('Please select a file to upload.');
      return;
    }
    const fileName = fileInput.files[0].name;
    const dateStr = new Date().toLocaleString();
    submittedAssignments.push({ subject, fileName, date: dateStr });
    localStorage.setItem('submittedAssignments', JSON.stringify(submittedAssignments));
    renderAssignments();
    assignmentForm.reset();
    alert('Assignment submitted successfully!');
    renderUpcomingDates();
  });


  // ======= INBOX MESSAGING =======
  const chatList = document.getElementById('chatList');
  const chatHeader = document.getElementById('chatHeader');
  const messageThread = document.getElementById('messageThread');
  const messageForm = document.getElementById('messageForm');
  const recipientSelect = document.getElementById('recipientSelect');
  const messageSubject = document.getElementById('messageSubject');
  const messageAttachment = document.getElementById('messageAttachment');

  let messages = JSON.parse(localStorage.getItem('messages') || '{}');
  let currentChat = 'IT Department';

  function renderMessageThread(chat) {
    chatHeader.textContent = chat;
    messageThread.innerHTML = '';
    const chatMessages = messages[chat] || [];
    chatMessages.forEach(m => {
      const div = document.createElement('div');
      div.className = 'message ' + (m.from === 'You' ? 'sent' : 'received');
      let attachmentInfo = m.attachment ? ` [Attachment: ${m.attachment}]` : '';
      div.textContent = `[${m.timestamp}] ${m.from}${m.subject ? ' - ' + m.subject : ''}: ${m.text}${attachmentInfo}`;
      messageThread.appendChild(div);
    });
    messageThread.scrollTop = messageThread.scrollHeight;
  }

  // Render incoming messages on home
  function renderIncomingMessages() {
    let allReceived = [];
    for (const chat in messages) {
      const chatMessages = messages[chat];
      chatMessages.forEach(m => {
        if (m.from !== 'You') {
          allReceived.push(`[${m.timestamp}] (${chat}) ${m.from}${m.subject ? ' - ' + m.subject : ''}: ${m.text}`);
        }
      });
    }
    incomingMessagesDiv.textContent = allReceived.slice(-10).join('\n') || 'No new messages.';
  }
  renderIncomingMessages();

  // Chat list click
  chatList.querySelectorAll('li').forEach(li => {
    li.addEventListener('click', () => {
      chatList.querySelectorAll('li').forEach(item => item.classList.remove('active'));
      li.classList.add('active');
      currentChat = li.textContent;
      renderMessageThread(currentChat);
    });
  });

  renderMessageThread(currentChat);

  // Send message form handler
  messageForm.addEventListener('submit', e => {
    e.preventDefault();
    const recipient = recipientSelect.value;
    const subject = messageSubject.value.trim();
    const text = messageForm.messageInput.value.trim();
    const attachmentFile = messageAttachment.files[0];

    if (!recipient) {
      alert('Please select a recipient.');
      return;
    }
    if (!subject) {
      alert('Please enter a subject.');
      return;
    }
    if (!text) {
      alert('Please enter a message.');
      return;
    }

    const now = new Date();
    const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Add to recipient thread
    if (!messages[recipient]) messages[recipient] = [];
    messages[recipient].push({
      from: 'You',
      subject,
      text,
      timestamp,
      attachment: attachmentFile ? attachmentFile.name : null
    });

    // Simulate reply
    setTimeout(() => {
      const replyTimestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messages[recipient].push({
        from: recipient,
        subject: 'Re: ' + subject,
        text: "Thanks for your message.",
        timestamp: replyTimestamp,
        attachment: null
      });
      if (currentChat === recipient) renderMessageThread(currentChat);
      renderIncomingMessages();
      localStorage.setItem('messages', JSON.stringify(messages));
    }, 2000);

    localStorage.setItem('messages', JSON.stringify(messages));
    renderMessageThread(currentChat);
    renderIncomingMessages();
    messageForm.reset();
  });


  // ======= EXAMS SECTION =======
  const examSubjectSelect = document.getElementById('examSubject');
  const loadExamsBtn = document.getElementById('loadExamsBtn');
  const examsContainer = document.getElementById('examsContainer');

  // Exams uploaded by teachers via staff portal - simulated here with sample DB
  const examsDB = {
    "Logic": [
      {
        id: "logic1",
        title: "Logic Basics Quiz",
        type: "mc",
        questions: [
          {
            q: "What is a valid argument?",
            options: ["One with true premises", "One with a false conclusion", "One with true premises and true conclusion", "One with an invalid form"],
            answer: 2
          },
          {
            q: "Which fallacy involves attacking the person?",
            options: ["Strawman", "Ad hominem", "Slippery slope", "False dilemma"],
            answer: 1
          }
        ],
        gradedByTeacher: false
      },
      {
        id: "logic2",
        title: "Logic Mixed Exam",
        type: "mixed",
        questions: [
          {
            q: "Explain what a syllogism is.",
            type: "word",
            answer: null
          },
          {
            q: "Which is a valid syllogism?",
            type: "mc",
            options: ["All men are mortal", "No men are mortal", "Some men are immortal", "None of these"],
            answer: 0
          }
        ],
        gradedByTeacher: true
      }
    ],
  };

  function createExamElement(exam) {
    const container = document.createElement('div');
    container.style.border = '1px solid var(--oxblood)';
    container.style.padding = '1rem';
    container.style.marginBottom = '1rem';
    container.style.borderRadius = '10px';

    const title = document.createElement('h3');
    title.textContent = exam.title;
    container.appendChild(title);

    const form = document.createElement('form');
    form.setAttribute('data-exam-id', exam.id);
    form.style.marginTop = '1rem';

    exam.questions.forEach((q, idx) => {
      const qDiv = document.createElement('div');
      qDiv.style.marginBottom = '0.8rem';

      const qLabel = document.createElement('label');
      qLabel.textContent = (idx + 1) + '. ' + q.q;
      qLabel.style.fontWeight = '600';
      qDiv.appendChild(qLabel);

      if (q.type === 'word' || q.type === undefined) {
        const textarea = document.createElement('textarea');
        textarea.name = 'q' + idx;
        textarea.rows = 3;
        textarea.style.width = '100%';
        qDiv.appendChild(textarea);
      } else if (q.type === 'mc') {
        q.options.forEach((opt, i) => {
          const optLabel = document.createElement('label');
          optLabel.style.display = 'block';
          optLabel.style.marginLeft = '1rem';
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'q' + idx;
          radio.value = i;
          optLabel.appendChild(radio);
          optLabel.appendChild(document.createTextNode(' ' + opt));
          qDiv.appendChild(optLabel);
        });
      }

      form.appendChild(qDiv);
    });

    const submitBtn = document.createElement('button');
    submitBtn.type = 'submit';
    submitBtn.textContent = 'Submit Exam';
    form.appendChild(submitBtn);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(form);
      let score = 0;
      let totalMC = 0;
      let unanswered = [];

      exam.questions.forEach((q, idx) => {
        if (q.type === 'mc') {
          totalMC++;
          const val = formData.get('q' + idx);
          if (val === null) {
            unanswered.push(idx + 1);
          } else if (parseInt(val) === q.answer) {
            score++;
          }
        }
      });

      if (unanswered.length) {
        alert('Please answer all multiple choice questions: #' + unanswered.join(', '));
        return;
      }
      if (!exam.gradedByTeacher) {
        alert(`Exam graded automatically.\nScore: ${score} out of ${totalMC} multiple choice questions.`);
      } else {
        alert(`Exam submitted for teacher review. You answered ${score} out of ${totalMC} multiple choice questions correctly.`);
      }
      form.reset();
    });

    container.appendChild(form);
    return container;
  }

  loadExamsBtn.addEventListener('click', () => {
    const subject = examSubjectSelect.value;
    examsContainer.innerHTML = '';
    if (!subject || !examsDB[subject]) {
      examsContainer.textContent = 'No exams available for this subject.';
      return;
    }
    examsDB[subject].forEach(exam => {
      const examEl = createExamElement(exam);
      examsContainer.appendChild(examEl);
    });
  });


  // ======= LIBRARY SECTION =======
  const genreSelect = document.getElementById('genreSelect');
  const bookList = document.getElementById('bookList');

  const libraryDB = {
    fiction: [
      { title: "Pride and Prejudice", link: "https://www.gutenberg.org/ebooks/1342" },
      { title: "The Adventures of Sherlock Holmes", link: "https://www.gutenberg.org/ebooks/1661" },
      { title: "The Scarlet Letter", link: "https://www.gutenberg.org/ebooks/33" },
      { title: "Dracula", link: "https://www.gutenberg.org/ebooks/345" }
    ],
    nonfiction: [
      { title: "The Art of War", link: "https://www.gutenberg.org/ebooks/132" },
      { title: "Meditations by Marcus Aurelius", link: "https://www.gutenberg.org/ebooks/2680" },
      { title: "Walden", link: "https://www.gutenberg.org/ebooks/205" },
      { title: "The Souls of Black Folk", link: "https://www.gutenberg.org/ebooks/408" }
    ],
    science: [
      { title: "On the Origin of Species", link: "https://www.gutenberg.org/ebooks/2009" },
      { title: "Relativity: The Special and General Theory", link: "https://www.gutenberg.org/ebooks/5001" },
      { title: "A Brief History of Time", link: "https://archive.org/details/BriefHistoryOfTime" },
      { title: "The Double Helix", link: "https://archive.org/details/TheDoubleHelix" }
    ],
    history: [
      { title: "The History of the Peloponnesian War", link: "https://www.gutenberg.org/ebooks/7142" },
      { title: "The Decline and Fall of the Roman Empire", link: "https://www.gutenberg.org/ebooks/731" },
      { title: "1776", link: "https://archive.org/details/1776" },
      { title: "The Guns of August", link: "https://archive.org/details/TheGunsOfAugust" }
    ],
    philosophy: [
      { title: "Beyond Good and Evil", link: "https://www.gutenberg.org/ebooks/4363" },
      { title: "The Republic by Plato", link: "https://www.gutenberg.org/ebooks/1497" },
      { title: "Meditations by Marcus Aurelius", link: "https://www.gutenberg.org/ebooks/2680" },
      { title: "The Prince", link: "https://www.gutenberg.org/ebooks/1232" }
    ],
    religion: [
      { title: "The Book of Mormon", link: "https://www.churchofjesuschrist.org/study/scriptures/bofm?lang=eng" },
      { title: "The Bible (King James Version)", link: "https://www.gutenberg.org/ebooks/10" },
      { title: "The Quran", link: "https://archive.org/details/TheQuran" },
      { title: "Tao Te Ching", link: "https://archive.org/details/TaoTeChing" }
    ],
    classic: [
      { title: "Moby Dick", link: "https://www.gutenberg.org/ebooks/2701" },
      { title: "Great Expectations", link: "https://www.gutenberg.org/ebooks/1400" },
      { title: "Les Misérables", link: "https://www.gutenberg.org/ebooks/135" },
      { title: "Alice's Adventures in Wonderland", link: "https://www.gutenberg.org/ebooks/11" }
    ]
  };

  function renderBooks(genre) {
    bookList.innerHTML = '';
    if (!genre || !libraryDB[genre]) {
      bookList.innerHTML = '<li>Please select a genre.</li>';
      return;
    }
    libraryDB[genre].forEach(book => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = book.link;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = book.title;
      li.appendChild(a);
      bookList.appendChild(li);
    });
  }

  genreSelect.addEventListener('change', () => {
    renderBooks(genreSelect.value);
  });

  renderBooks(genreSelect.value);


  // ======= CALENDAR (unchanged) =======
  const calendarTableBody = document.querySelector('#calendar tbody');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const addEventBtn = document.getElementById('addEventBtn');
  const eventModal = document.getElementById('eventModal');
  const eventDateInput = document.getElementById('eventDateInput');
  const eventDescInput = document.getElementById('eventDescInput');
  const eventForm = document.getElementById('eventForm');
  const cancelEventBtn = document.getElementById('cancelEventBtn');

  let currentDate = new Date();
  let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '{}');

  function renderCalendar(date) {
    calendarTableBody.innerHTML = '';
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let dayCount = 1;

    for (let row = 0; row < 6; row++) {
      const tr = document.createElement('tr');
      for (let col = 0; col < 7; col++) {
        const td = document.createElement('td');
        if(row === 0 && col < firstDay) {
          td.textContent = '';
        } else if(dayCount > daysInMonth) {
          td.textContent = '';
        } else {
          td.textContent = dayCount;
          // Highlight if event exists
          const ymd = `${year}-${String(month+1).padStart(2,'0')}-${String(dayCount).padStart(2,'0')}`;
          if(calendarEvents[ymd]) {
            td.style.backgroundColor = 'var(--oxblood)';
            td.style.color = 'var(--parchment)';
            td.title = calendarEvents[ymd].join(', ');
          }
          dayCount++;
        }
        tr.appendChild(td);
      }
      calendarTableBody.appendChild(tr);
    }
  }

  prevMonthBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });

  nextMonthBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });

  addEventBtn.addEventListener('click', () => {
    eventModal.style.display = 'flex';
    eventDateInput.value = '';
    eventDescInput.value = '';
    eventDateInput.focus();
  });

  cancelEventBtn.addEventListener('click', () => {
    eventModal.style.display = 'none';
  });

  eventForm.addEventListener('submit', e => {
    e.preventDefault();
    const date = eventDateInput.value;
    const desc = eventDescInput.value.trim();
    if (!date || !desc) {
      alert('Please enter both date and description.');
      return;
    }
    if (!calendarEvents[date]) calendarEvents[date] = [];
    calendarEvents[date].push(desc);
    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
    renderCalendar(currentDate);
    eventModal.style.display = 'none';
    renderUpcomingDates();
  });

  renderCalendar(currentDate);


  // ======= SETTINGS =======
  const settingsForm = document.getElementById('settingsForm');
  const profilePicInput = document.getElementById('profilePicInput');
  const profilePicPreview = document.getElementById('profilePicPreview');

  profilePicInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      profilePicPreview.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  settingsForm.addEventListener('submit', e => {
    e.preventDefault();
    alert('Settings saved! (Note: saving profile picture and security info is not persistent in this demo.)');
  });


  // ======= HOME PAGE UPDATES: NEWS & UPCOMING DATES =======
  // Load reliable news feed iframe (e.g., NPR)
  newsSection.innerHTML = `
    <h3>Current News</h3>
    <iframe
      src="https://www.npr.org/sections/news/"
      style="width:100%; height:300px; border:none;"
      title="Reliable Current News"
      sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
    ></iframe>
  `;

  function renderUpcomingDates() {
    upcomingDatesList.innerHTML = '';
    // Combine calendar events and upcoming assignment deadlines/exams (mocked here as deadlines 3 days from submission)
    let combined = [];

    // Calendar events upcoming from today
    const today = new Date();
    Object.entries(calendarEvents).forEach(([date, descs]) => {
      const eventDate = new Date(date);
      if (eventDate >= today) {
        descs.forEach(d => {
          combined.push({ date: eventDate, desc: d });
        });
      }
    });

    // Assignments deadlines: 3 days after submission (demo)
    submittedAssignments.forEach(a => {
      const subDate = new Date(a.date);
      const dueDate = new Date(subDate);
      dueDate.setDate(dueDate.getDate() + 3);
      if (dueDate >= today) {
        combined.push({ date: dueDate, desc: `Assignment Due: ${a.subject} (${a.fileName})` });
      }
    });

    // Sort by date ascending
    combined.sort((a, b) => a.date - b.date);

    if (combined.length === 0) {
      upcomingDatesList.innerHTML = '<li>No upcoming important dates.</li>';
      return;
    }
    combined.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.date.toDateString()}: ${item.desc}`;
      upcomingDatesList.appendChild(li);
    });
  }

  renderUpcomingDates();

})();

</script>

</body>
</html>

